<?xml version="1.0" encoding="utf-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2008/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <Body>
    <ReportItems>
      <Tablix Name="Tablix1">
        <TablixBody>
          <TablixColumns>
            <TablixColumn>
              <Width>24.725cm</Width>
            </TablixColumn>
          </TablixColumns>
          <TablixRows>
            <TablixRow>
              <Height>0.07938cm</Height>
              <TablixCells>
                <TablixCell>
                  <CellContents>
                    <Rectangle Name="Rectangle1">
                      <KeepTogether>true</KeepTogether>
                      <Style>
                        <Border>
                          <Style>None</Style>
                        </Border>
                        <BackgroundColor>WhiteSmoke</BackgroundColor>
                      </Style>
                    </Rectangle>
                  </CellContents>
                </TablixCell>
              </TablixCells>
            </TablixRow>
            <TablixRow>
              <Height>11.15687cm</Height>
              <TablixCells>
                <TablixCell>
                  <CellContents>
                    <Chart Name="Chart2">
                      <ChartCategoryHierarchy>
                        <ChartMembers>
                          <ChartMember>
                            <Group Name="Chart2_CategoryGroup">
                              <GroupExpressions>
                                <GroupExpression>=Fields!IntervalInt.Value</GroupExpression>
                              </GroupExpressions>
                            </Group>
                            <SortExpressions>
                              <SortExpression>
                                <Value>=Fields!IntervalInt.Value</Value>
                              </SortExpression>
                            </SortExpressions>
                            <Label>= IIF(Fields!IntervalInt.Value = 1, CStr(Fields!IntervalInt.Value) + " месяц", 
   IIf(Fields!IntervalInt.Value = 2 Or Fields!IntervalInt.Value = 3 Or Fields!IntervalInt.Value = 4, Cstr(Fields!IntervalInt.Value) + " месяца",
    Cstr(Fields!IntervalInt.Value) + " месяцев"))</Label>
                          </ChartMember>
                        </ChartMembers>
                      </ChartCategoryHierarchy>
                      <ChartSeriesHierarchy>
                        <ChartMembers>
                          <ChartMember>
                            <Label>Sum Interval Count</Label>
                          </ChartMember>
                        </ChartMembers>
                      </ChartSeriesHierarchy>
                      <ChartData>
                        <ChartSeriesCollection>
                          <ChartSeries Name="SumIntervalCount">
                            <ChartDataPoints>
                              <ChartDataPoint>
                                <ChartDataPointValues>
                                  <Y>=Sum(Fields!SumIntervalCount.Value)</Y>
                                </ChartDataPointValues>
                                <ChartDataLabel>
                                  <Style>
                                    <FontSize>8pt</FontSize>
                                    <Format>0 %</Format>
                                  </Style>
                                  <Label>#PERCENT</Label>
                                  <Visible>true</Visible>
                                </ChartDataLabel>
                                <Style />
                                <ChartMarker>
                                  <Style />
                                </ChartMarker>
                                <DataElementOutput>Output</DataElementOutput>
                              </ChartDataPoint>
                            </ChartDataPoints>
                            <Type>Shape</Type>
                            <Style />
                            <ChartEmptyPoints>
                              <Style />
                              <ChartMarker>
                                <Style />
                              </ChartMarker>
                              <ChartDataLabel>
                                <Style />
                              </ChartDataLabel>
                            </ChartEmptyPoints>
                            <ValueAxisName>Primary</ValueAxisName>
                            <CategoryAxisName>Primary</CategoryAxisName>
                            <ChartSmartLabel>
                              <CalloutLineColor>Black</CalloutLineColor>
                              <MinMovingDistance>0pt</MinMovingDistance>
                            </ChartSmartLabel>
                          </ChartSeries>
                        </ChartSeriesCollection>
                      </ChartData>
                      <ChartAreas>
                        <ChartArea Name="Default">
                          <ChartCategoryAxes>
                            <ChartAxis Name="Primary">
                              <Style>
                                <FontSize>8pt</FontSize>
                              </Style>
                              <ChartAxisTitle>
                                <Caption>Axis Title</Caption>
                                <Style>
                                  <FontSize>8pt</FontSize>
                                </Style>
                              </ChartAxisTitle>
                              <ChartMajorGridLines>
                                <Enabled>False</Enabled>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                  </Border>
                                </Style>
                              </ChartMajorGridLines>
                              <ChartMinorGridLines>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                    <Style>Dotted</Style>
                                  </Border>
                                </Style>
                              </ChartMinorGridLines>
                              <ChartMinorTickMarks>
                                <Length>0.5</Length>
                              </ChartMinorTickMarks>
                              <CrossAt>NaN</CrossAt>
                              <Minimum>NaN</Minimum>
                              <Maximum>NaN</Maximum>
                              <ChartAxisScaleBreak>
                                <Style />
                              </ChartAxisScaleBreak>
                            </ChartAxis>
                            <ChartAxis Name="Secondary">
                              <Style>
                                <FontSize>8pt</FontSize>
                              </Style>
                              <ChartAxisTitle>
                                <Caption>Axis Title</Caption>
                                <Style>
                                  <FontSize>8pt</FontSize>
                                </Style>
                              </ChartAxisTitle>
                              <ChartMajorGridLines>
                                <Enabled>False</Enabled>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                  </Border>
                                </Style>
                              </ChartMajorGridLines>
                              <ChartMinorGridLines>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                    <Style>Dotted</Style>
                                  </Border>
                                </Style>
                              </ChartMinorGridLines>
                              <ChartMinorTickMarks>
                                <Length>0.5</Length>
                              </ChartMinorTickMarks>
                              <CrossAt>NaN</CrossAt>
                              <Location>Opposite</Location>
                              <Minimum>NaN</Minimum>
                              <Maximum>NaN</Maximum>
                              <ChartAxisScaleBreak>
                                <Style />
                              </ChartAxisScaleBreak>
                            </ChartAxis>
                          </ChartCategoryAxes>
                          <ChartValueAxes>
                            <ChartAxis Name="Primary">
                              <Style>
                                <FontSize>8pt</FontSize>
                              </Style>
                              <ChartAxisTitle>
                                <Caption>Axis Title</Caption>
                                <Style>
                                  <FontSize>8pt</FontSize>
                                </Style>
                              </ChartAxisTitle>
                              <ChartMajorGridLines>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                  </Border>
                                </Style>
                              </ChartMajorGridLines>
                              <ChartMinorGridLines>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                    <Style>Dotted</Style>
                                  </Border>
                                </Style>
                              </ChartMinorGridLines>
                              <ChartMinorTickMarks>
                                <Length>0.5</Length>
                              </ChartMinorTickMarks>
                              <CrossAt>NaN</CrossAt>
                              <Minimum>NaN</Minimum>
                              <Maximum>NaN</Maximum>
                              <ChartAxisScaleBreak>
                                <Style />
                              </ChartAxisScaleBreak>
                            </ChartAxis>
                            <ChartAxis Name="Secondary">
                              <Style>
                                <FontSize>8pt</FontSize>
                              </Style>
                              <ChartAxisTitle>
                                <Caption>Axis Title</Caption>
                                <Style>
                                  <FontSize>8pt</FontSize>
                                </Style>
                              </ChartAxisTitle>
                              <ChartMajorGridLines>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                  </Border>
                                </Style>
                              </ChartMajorGridLines>
                              <ChartMinorGridLines>
                                <Style>
                                  <Border>
                                    <Color>Gainsboro</Color>
                                    <Style>Dotted</Style>
                                  </Border>
                                </Style>
                              </ChartMinorGridLines>
                              <ChartMinorTickMarks>
                                <Length>0.5</Length>
                              </ChartMinorTickMarks>
                              <CrossAt>NaN</CrossAt>
                              <Location>Opposite</Location>
                              <Minimum>NaN</Minimum>
                              <Maximum>NaN</Maximum>
                              <ChartAxisScaleBreak>
                                <Style />
                              </ChartAxisScaleBreak>
                            </ChartAxis>
                          </ChartValueAxes>
                          <Style>
                            <BackgroundGradientType>None</BackgroundGradientType>
                          </Style>
                        </ChartArea>
                      </ChartAreas>
                      <ChartLegends>
                        <ChartLegend Name="Default">
                          <Style>
                            <BackgroundGradientType>None</BackgroundGradientType>
                            <FontSize>8pt</FontSize>
                          </Style>
                          <ChartLegendTitle>
                            <Caption />
                            <Style>
                              <FontSize>8pt</FontSize>
                              <FontWeight>Bold</FontWeight>
                              <TextAlign>Center</TextAlign>
                            </Style>
                          </ChartLegendTitle>
                          <HeaderSeparatorColor>Black</HeaderSeparatorColor>
                          <ColumnSeparatorColor>Black</ColumnSeparatorColor>
                        </ChartLegend>
                      </ChartLegends>
                      <ChartTitles>
                        <ChartTitle Name="Default">
                          <Caption>=IIf(Fields!HasActivityLastMonth.Value = 0, "Не было активности в последнем месяце", "Была активность в последнем месяце")</Caption>
                          <Style>
                            <BackgroundGradientType>None</BackgroundGradientType>
                            <FontWeight>Bold</FontWeight>
                            <TextAlign>General</TextAlign>
                            <VerticalAlign>Top</VerticalAlign>
                          </Style>
                        </ChartTitle>
                      </ChartTitles>
                      <Palette>BrightPastel</Palette>
                      <ChartBorderSkin>
                        <Style>
                          <BackgroundColor>Gray</BackgroundColor>
                          <BackgroundGradientType>None</BackgroundGradientType>
                          <Color>White</Color>
                        </Style>
                      </ChartBorderSkin>
                      <ChartNoDataMessage Name="NoDataMessage">
                        <Caption>No Data Available</Caption>
                        <Style>
                          <BackgroundGradientType>None</BackgroundGradientType>
                          <TextAlign>General</TextAlign>
                          <VerticalAlign>Top</VerticalAlign>
                        </Style>
                      </ChartNoDataMessage>
                      <DataSetName>DStMain</DataSetName>
                      <Style>
                        <Border>
                          <Color>LightGrey</Color>
                          <Style>Solid</Style>
                        </Border>
                        <BackgroundColor>White</BackgroundColor>
                        <BackgroundGradientType>None</BackgroundGradientType>
                      </Style>
                    </Chart>
                  </CellContents>
                </TablixCell>
              </TablixCells>
            </TablixRow>
          </TablixRows>
        </TablixBody>
        <TablixColumnHierarchy>
          <TablixMembers>
            <TablixMember />
          </TablixMembers>
        </TablixColumnHierarchy>
        <TablixRowHierarchy>
          <TablixMembers>
            <TablixMember>
              <Group Name="Details" />
            </TablixMember>
            <TablixMember>
              <Group Name="HasActivityLastMonth">
                <GroupExpressions>
                  <GroupExpression>=Fields!HasActivityLastMonth.Value</GroupExpression>
                </GroupExpressions>
              </Group>
              <SortExpressions>
                <SortExpression>
                  <Value>=Fields!HasActivityLastMonth.Value</Value>
                </SortExpression>
              </SortExpressions>
            </TablixMember>
          </TablixMembers>
        </TablixRowHierarchy>
        <DataSetName>DStMain</DataSetName>
        <Top>0.73766cm</Top>
        <Height>11.23625cm</Height>
        <Width>24.725cm</Width>
        <Style>
          <Border>
            <Style>None</Style>
          </Border>
          <BackgroundColor>White</BackgroundColor>
        </Style>
      </Tablix>
      <Textbox Name="Textbox6">
        <CanGrow>true</CanGrow>
        <KeepTogether>true</KeepTogether>
        <Paragraphs>
          <Paragraph>
            <TextRuns>
              <TextRun>
                <Value>="Кол-во перерывов в публикациях вакансий за последний год у компаний активных по состоянию на " + Format(Parameters!Date.Value, "dd.MM.yyyy")</Value>
                <Style>
                  <FontSize>12pt</FontSize>
                  <FontWeight>Bold</FontWeight>
                </Style>
              </TextRun>
            </TextRuns>
            <Style />
          </Paragraph>
        </Paragraphs>
        <rd:DefaultName>Textbox6</rd:DefaultName>
        <Height>0.65652cm</Height>
        <Width>24.725cm</Width>
        <ZIndex>1</ZIndex>
        <Style>
          <Border>
            <Style>None</Style>
          </Border>
          <PaddingLeft>2pt</PaddingLeft>
          <PaddingRight>2pt</PaddingRight>
          <PaddingTop>2pt</PaddingTop>
          <PaddingBottom>2pt</PaddingBottom>
        </Style>
      </Textbox>
    </ReportItems>
    <Height>4.71414in</Height>
    <Style>
      <BackgroundColor>WhiteSmoke</BackgroundColor>
    </Style>
  </Body>
  <Width>9.73425in</Width>
  <Page>
    <PageHeight>29.7cm</PageHeight>
    <PageWidth>21cm</PageWidth>
    <InteractiveHeight>0cm</InteractiveHeight>
    <InteractiveWidth>21cm</InteractiveWidth>
    <LeftMargin>2cm</LeftMargin>
    <RightMargin>2cm</RightMargin>
    <TopMargin>2cm</TopMargin>
    <BottomMargin>2cm</BottomMargin>
    <ColumnSpacing>0.13cm</ColumnSpacing>
    <Style>
      <BackgroundColor>WhiteSmoke</BackgroundColor>
    </Style>
  </Page>
  <AutoRefresh>0</AutoRefresh>
  <DataSources>
    <DataSource Name="DSrcAnalytics">
      <DataSourceReference>DSrcAnalytics</DataSourceReference>
      <rd:SecurityType>None</rd:SecurityType>
      <rd:DataSourceID>4db2b462-622e-4df5-9de1-4a05e44bfef5</rd:DataSourceID>
    </DataSource>
  </DataSources>
  <DataSets>
    <DataSet Name="DStMain">
      <Query>
        <DataSourceName>DSrcAnalytics</DataSourceName>
        <QueryParameters>
          <QueryParameter Name="@Date">
            <Value>=Parameters!Date.Value</Value>
          </QueryParameter>
        </QueryParameters>
        <CommandText>DECLARE @Date12Ago DATETIME; SET @Date12Ago = DATEADD(MONTH, -12, @Date);
DECLARE @Date6Ago DATETIME; SET @Date6Ago = DATEADD(MONTH, -6, @Date);
DECLARE @Date3Ago DATETIME; SET @Date3Ago = DATEADD(MONTH, -3, @Date);
DECLARE @Date1Ago DATETIME; SET @Date1Ago = DATEADD(MONTH, -1, @Date);

WITH C_NotebooksActivity AS
 (
SELECT 
   NC.NotebookID
 , (SELECT COUNT(*) FROM dbo.NotebookCompany_Spent WHERE NotebookID = NC.NotebookId AND AddDate BETWEEN @Date3Ago AND @Date) AS Publications3Month
 , (SELECT COUNT(*) FROM dbo.DailyViewedResume WHERE EmployerNotebookID = NC.NotebookId AND ViewDate BETWEEN @Date3Ago AND @Date - 1) AS ContactsOpened3Month
 , (SELECT COUNT(*) FROM dbo.NotebookCompany_Spent WHERE NotebookID = NC.NotebookId AND AddDate BETWEEN @Date1Ago AND @Date) AS Publications1Month
 , (SELECT COUNT(*) FROM dbo.DailyViewedResume WHERE EmployerNotebookID = NC.NotebookId AND ViewDate BETWEEN @Date1Ago AND @Date - 1) AS ContactsOpened1Month
FROM dbo.NotebookCompany NC
 JOIN dbo.Notebook N ON NC.NotebookId = N.Id
 JOIN dbo.NotebookState NS ON N.NotebookStateId = NS.Id
 JOIN dbo.Manager M ON NC.ManagerId = M.Id
 LEFT JOIN dbo.EmployerPost EP ON NC.EmployerPostID = EP.ID
 LEFT JOIN dbo.NotebookCompanyCountEmployee_dir CntEmp ON NC.CountEmp = CntEmp.Id
 LEFT JOIN dbo.City C ON NC.HeadquarterCityId = C.Id
WHERE NOT EXISTS (SELECT * FROM dbo.NotebookCompanyMerged NCM WHERE NCM.SourceNotebookID = NC.NotebookId)
 AND N.NotebookStateId IN (5,7)
 AND NC.AddDate &lt; @Date6Ago
 )
 , C_ActiveNotebooks AS
 (
SELECT
   CASE 
    WHEN Publications1Month &gt; 0 OR ContactsOpened1Month &gt; 0 THEN 1
	ELSE 0 
   END AS 'HasActivityLastMonth'
 , NotebookID 
FROM C_NotebooksActivity
WHERE Publications3Month &gt; 0 OR ContactsOpened3Month &gt; 0
 )
 , C_PublicationHistory AS 
 (
SELECT AN.NotebookID, AN.HasActivityLastMonth, Activity.AddDate
 , ROW_NUMBER() OVER(PARTITION BY AN.NotebookID ORDER BY Activity.AddDate) AS RowNum
FROM C_ActiveNotebooks AN
 JOIN (SELECT NotebookID, AddDate
	   FROM dbo.NotebookCompany_Spent NCS
	   WHERE NCS.NotebookID IN (SELECT NotebookID FROM C_ActiveNotebooks)
	    AND NCS.AddDate BETWEEN @Date12Ago AND @Date
	   UNION ALL
	   SELECT DISTINCT EmployerNotebookID, ViewDate
	   FROM dbo.DailyViewedResume DVR
	   WHERE DVR.EmployerNotebookID IN (SELECT NotebookID FROM C_ActiveNotebooks)
	    AND DVR.ViewDate BETWEEN @Date12Ago AND @Date - 1) Activity ON AN.NotebookId = Activity.NotebookID
 )
 , C_NotebookIntervals AS
 (
SELECT PH1.*, PH2.AddDate AS AddDateNext, CAST(DATEDIFF(DAY, PH1.AddDate, PH2.AddDate) / 30 AS INT) AS IntervalInt
FROM C_PublicationHistory PH1
 LEFT JOIN C_PublicationHistory PH2 ON PH1.NotebookID = PH2.NotebookID AND PH1.RowNum + 1 = PH2.RowNum
 )
 , C_IntervalsCount AS
 (
SELECT NotebookID, HasActivityLastMonth, IntervalInt, COUNT(*) AS IntervalCount
FROM C_NotebookIntervals
WHERE IntervalInt &gt; 0
GROUP BY NotebookID, HasActivityLastMonth, IntervalInt
 )
SELECT IntervalInt, HasActivityLastMonth, SUM(IntervalCount) AS SumIntervalCount
FROM C_IntervalsCount
GROUP BY IntervalInt, HasActivityLastMonth</CommandText>
      </Query>
      <Fields>
        <Field Name="IntervalInt">
          <DataField>IntervalInt</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="HasActivityLastMonth">
          <DataField>HasActivityLastMonth</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="SumIntervalCount">
          <DataField>SumIntervalCount</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <ReportParameters>
    <ReportParameter Name="Date">
      <DataType>DateTime</DataType>
      <DefaultValue>
        <Values>
          <Value>04/01/2014 00:00:00</Value>
        </Values>
      </DefaultValue>
      <Prompt>Выберите дату:</Prompt>
    </ReportParameter>
  </ReportParameters>
  <rd:ReportUnitType>Cm</rd:ReportUnitType>
  <rd:ReportID>05f1ab33-fcac-4679-9605-9c2922ed2e57</rd:ReportID>
</Report>